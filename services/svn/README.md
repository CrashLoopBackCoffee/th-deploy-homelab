# Subversion (svn) Service

Self‑hosted Apache Subversion served by httpd (image `obslib/subversion:<version>`), deployed to Kubernetes. Repositories are stored under `/var/svn/repos` on a PersistentVolume. Traefik exposes the service at `https://svn.<zone>` and the parent listing is enabled at `https://svn.<zone>/repos`.

## Authentication

- Basic auth is required for all access.
- Users come from an `.htpasswd` file mounted from a Kubernetes Secret generated by Pulumi from your config.
- Configure users with pre‑hashed passwords in your stack config (example for `Pulumi.prod.yaml`):

```yaml
config:
  svn:config:
    cloudflare:
      api-key:
        ref: op://Pulumi/Cloudflare Global API Key/password
      email: you@example.com
      zone: example.com
    svn:
      # renovate: datasource=docker packageName=obslib/subversion versioning=semver
      version: httpd-1.14.2
      auth:
        users:
          - username: alice
            password-hash:
              ref: op://Vault/Item/alice-htpasswd-hash
          - username: bob
            password-hash:
              ref: op://Vault/Item/bob-htpasswd-hash
```

Notes:
- `password-hash` must be a valid htpasswd hash (e.g., bcrypt/MD5). The Secret content is assembled as `username:hash` lines.
- Update the config and run Pulumi to rotate credentials.

## Browse and verify

- List parent: `curl -u <user>:<pass> https://svn.<zone>/repos/`
- Verify a repo: `svn list https://svn.<zone>/repos/<repo-name> --username <user>`

## Create a new repository

Use `svnadmin` inside the running pod; repositories live under `/var/svn/repos/<repo-name>`.

```bash
kubectl -n svn exec deploy/svn -- \
  /usr/local/subversion/bin/svnadmin create /var/svn/repos/<repo-name>
```

Alternatively, use the helper wrapper (forwards args to `svnadmin` inside the pod):

```bash
# Create (pass full repo path)
(cd services/svn && ./scripts/svnadmin.sh create /var/svn/repos/<repo-name>)

# Load from stdin (gzipped)
gzip -dc /path/to/repo.svndump.gz | (cd services/svn && ./scripts/svnadmin.sh load /var/svn/repos/<repo-name>)

# Load from local dump file with shell redirection
(cd services/svn && ./scripts/svnadmin.sh load /var/svn/repos/<repo-name>) < /path/to/repo.svndump
```

## Create a repository and import a dump

- Stream a plain dump from your machine:

```bash
cat /path/to/repo.svndump | kubectl -n svn exec -i deploy/svn -- \
  /bin/sh -c \
  "/usr/local/subversion/bin/svnadmin create /var/svn/repos/<repo-name> && \
   /usr/local/subversion/bin/svnadmin load /var/svn/repos/<repo-name>"
```

- Stream a gzipped dump:

```bash
gzip -dc /path/to/repo.svndump.gz | kubectl -n svn exec -i deploy/svn -- \
  /bin/sh -c \
  "/usr/local/subversion/bin/svnadmin create /var/svn/repos/<repo-name> && \
   /usr/local/subversion/bin/svnadmin load /var/svn/repos/<repo-name>"
```

- Copy the dump first (useful for very large files):

```bash
kubectl -n svn cp /path/to/repo.svndump deploy/svn:/tmp/repo.svndump
kubectl -n svn exec deploy/svn -- \
  /bin/sh -c \
  "/usr/local/subversion/bin/svnadmin create /var/svn/repos/<repo-name> && \
   /usr/local/subversion/bin/svnadmin load /var/svn/repos/<repo-name> < /tmp/repo.svndump"
```

## Operational notes

- Parent listing is enabled via `SVNListParentPath on`; `/repos` shows available repositories (auth required by default).
- The main container runs as `www-data` (uid/gid 33); the pod sets `fsGroup: 33` so the PVC is writable by the service.
- Apache listens on 8080 in the container; the Service maps port 80 -> 8080.
- Logs are written to stdout/stderr (captured by `kubectl logs`). A writable emptyDir is mounted at `/usr/local/httpd/logs` for PID/log files.
- Data persists on the PVC mounted at `/var/svn`.

## Deploy

Always preview before applying:

```bash
(cd services/svn && pulumi preview -s prod --diff --non-interactive)
(cd services/svn && pulumi up --stack prod --non-interactive --skip-preview)
```
